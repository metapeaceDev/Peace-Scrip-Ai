#!/bin/bash

# Pre-commit hook to prevent committing sensitive files and API keys
# Install: git config core.hooksPath .githooks

echo "ğŸ”’ Running security checks..."

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Check for sensitive files
SENSITIVE_FILES=".env .env.local .env.production"
FOUND_SENSITIVE=false

for file in $SENSITIVE_FILES; do
  if git diff --cached --name-only | grep -q "^${file}$"; then
    echo -e "${RED}âŒ ERROR: Attempting to commit sensitive file: ${file}${NC}"
    FOUND_SENSITIVE=true
  fi
done

# Check for API keys in staged files
if git diff --cached | grep -qiE 'AIza[0-9A-Za-z_-]{35}'; then
  echo -e "${RED}âŒ ERROR: Google API key detected in staged changes!${NC}"
  echo -e "${YELLOW}   Pattern: AIza[0-9A-Za-z_-]{35}${NC}"
  echo -e "${YELLOW}   Please remove API keys before committing.${NC}"
  FOUND_SENSITIVE=true
fi

# Check for Firebase config keys in non-example files
if git diff --cached --name-only | grep -v "example" | xargs git diff --cached | grep -qE 'apiKey.*:.*"[A-Za-z0-9_-]{30,}"'; then
  echo -e "${YELLOW}âš ï¸  WARNING: Possible Firebase config detected${NC}"
  echo -e "${YELLOW}   Make sure you're not committing real API keys${NC}"
fi

# Check .env.template and .env.example for real keys
for file in .env.template .env.example; do
  if git diff --cached --name-only | grep -q "$file"; then
    if git diff --cached "$file" | grep -qE 'AIza[0-9A-Za-z_-]{35}'; then
      echo -e "${RED}âŒ ERROR: Real API key found in $file!${NC}"
      echo -e "${YELLOW}   Template files should only contain placeholders${NC}"
      FOUND_SENSITIVE=true
    fi
  fi
done

if [ "$FOUND_SENSITIVE" = true ]; then
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${RED}ğŸš¨ COMMIT BLOCKED - Sensitive data detected!${NC}"
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${YELLOW}To fix:${NC}"
  echo "  1. Remove API keys from your changes"
  echo "  2. Use environment variables instead"
  echo "  3. Add sensitive files to .gitignore"
  echo ""
  exit 1
fi

echo -e "${GREEN}âœ… Security checks passed${NC}"
exit 0
