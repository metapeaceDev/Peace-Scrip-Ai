<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Peace Script Sync</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #00ff00;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #00ff00; border-bottom: 2px solid #00ff00; padding-bottom: 10px; }
        h2 { color: #ffcc00; margin-top: 30px; }
        button {
            background: #00ff00;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 10px 10px 0;
            border-radius: 5px;
        }
        button:hover { background: #00cc00; }
        .output {
            background: #0f0f1e;
            border: 1px solid #00ff00;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffcc00; }
        .info { color: #00ccff; }
    </style>
</head>
<body>
    <h1>üîß Peace Script Debug Tool</h1>
    
    <h2>1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IndexedDB (Local)</h2>
    <button onclick="checkIndexedDB()">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IndexedDB</button>
    <div id="indexeddb-output" class="output"></div>

    <h2>2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firestore (Cloud)</h2>
    <button onclick="loginAndCheckFirestore()">üîê Login ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π Firestore</button>
    <div id="firestore-output" class="output"></div>

    <h2>3. Sync Projects</h2>
    <button onclick="syncProjects()">üîÑ Sync ‡∏à‡∏≤‡∏Å IndexedDB ‡πÑ‡∏õ Firestore</button>
    <div id="sync-output" class="output"></div>

    <h2>4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
    <button onclick="createTestProject()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô IndexedDB</button>
    <div id="create-output" class="output"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, setDoc, query, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCMZn8sVtszG_gl1NHjbViAnPy6JVeCHvo",
            authDomain: "peace-script-ai.firebaseapp.com",
            projectId: "peace-script-ai",
            storageBucket: "peace-script-ai.firebasestorage.app",
            messagingSenderId: "668942944030",
            appId: "1:668942944030:web:9a0c3c8dcbe8de3c8e0eae"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IndexedDB
        window.checkIndexedDB = async function() {
            const output = document.getElementById('indexeddb-output');
            output.innerHTML = '<span class="info">üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IndexedDB...</span>\n\n';

            try {
                const dbRequest = indexedDB.open('PeaceScriptDB', 1);
                
                dbRequest.onsuccess = function(event) {
                    const database = event.target.result;
                    const objectStoreNames = database.objectStoreNames;
                    
                    output.innerHTML += `<span class="success">‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î IndexedDB ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>\n`;
                    output.innerHTML += `<span class="info">üì¶ Object Stores: ${Array.from(objectStoreNames).join(', ')}</span>\n\n`;

                    if (objectStoreNames.contains('projects')) {
                        const transaction = database.transaction('projects', 'readonly');
                        const store = transaction.objectStore('projects');
                        const getAllRequest = store.getAll();

                        getAllRequest.onsuccess = function() {
                            const projects = getAllRequest.result;
                            output.innerHTML += `<span class="success">üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡πÉ‡∏ô IndexedDB: ${projects.length}</span>\n\n`;
                            
                            if (projects.length > 0) {
                                projects.forEach((project, index) => {
                                    output.innerHTML += `<span class="info">‚îÅ‚îÅ‚îÅ ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ #${index + 1} ‚îÅ‚îÅ‚îÅ</span>\n`;
                                    output.innerHTML += `  ID: ${project.id}\n`;
                                    output.innerHTML += `  Title: ${project.title}\n`;
                                    output.innerHTML += `  Type: ${project.projectType || 'N/A'}\n`;
                                    output.innerHTML += `  Last Modified: ${new Date(project.lastModified).toLocaleString('th-TH')}\n\n`;
                                });
                            } else {
                                output.innerHTML += `<span class="warning">‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡πÉ‡∏ô IndexedDB</span>\n`;
                            }
                        };

                        getAllRequest.onerror = function() {
                            output.innerHTML += `<span class="error">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡πÑ‡∏î‡πâ</span>\n`;
                        };
                    } else {
                        output.innerHTML += `<span class="warning">‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö 'projects' store ‡πÉ‡∏ô IndexedDB</span>\n`;
                    }
                };

                dbRequest.onerror = function() {
                    output.innerHTML += `<span class="error">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î IndexedDB ‡πÑ‡∏î‡πâ</span>\n`;
                };
            } catch (error) {
                output.innerHTML += `<span class="error">‚ùå Error: ${error.message}</span>\n`;
            }
        };

        // Login ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firestore
        window.loginAndCheckFirestore = async function() {
            const output = document.getElementById('firestore-output');
            const email = prompt('‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•:');
            const password = prompt('‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:');

            if (!email || !password) {
                output.innerHTML = '<span class="error">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</span>\n';
                return;
            }

            output.innerHTML = '<span class="info">üîê ‡∏Å‡∏≥‡∏•‡∏±‡∏á Login...</span>\n\n';

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                output.innerHTML += `<span class="success">‚úÖ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${currentUser.email}</span>\n`;
                output.innerHTML += `<span class="info">üë§ UID: ${currentUser.uid}</span>\n\n`;

                // ‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡∏à‡∏≤‡∏Å Firestore
                output.innerHTML += '<span class="info">üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡∏à‡∏≤‡∏Å Firestore...</span>\n\n';
                
                const q = query(collection(db, 'projects'), where('userId', '==', currentUser.uid));
                const querySnapshot = await getDocs(q);
                
                output.innerHTML += `<span class="success">üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡πÉ‡∏ô Firestore: ${querySnapshot.size}</span>\n\n`;
                
                if (querySnapshot.size > 0) {
                    let index = 0;
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        output.innerHTML += `<span class="info">‚îÅ‚îÅ‚îÅ ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ #${++index} ‚îÅ‚îÅ‚îÅ</span>\n`;
                        output.innerHTML += `  ID: ${doc.id}\n`;
                        output.innerHTML += `  Title: ${data.title || 'N/A'}\n`;
                        output.innerHTML += `  Type: ${data.type || 'N/A'}\n`;
                        output.innerHTML += `  Created: ${data.createdAt?.toDate().toLocaleString('th-TH') || 'N/A'}\n\n`;
                    });
                } else {
                    output.innerHTML += `<span class="warning">‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡πÉ‡∏ô Firestore</span>\n`;
                }
            } catch (error) {
                output.innerHTML += `<span class="error">‚ùå Error: ${error.message}</span>\n`;
            }
        };

        // Sync Projects
        window.syncProjects = async function() {
            const output = document.getElementById('sync-output');
            
            if (!currentUser) {
                output.innerHTML = '<span class="error">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô (‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° "Login ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π Firestore")</span>\n';
                return;
            }

            output.innerHTML = '<span class="info">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Sync...</span>\n\n';

            try {
                // ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å IndexedDB
                const dbRequest = indexedDB.open('PeaceScriptDB', 1);
                
                dbRequest.onsuccess = async function(event) {
                    const database = event.target.result;
                    
                    if (!database.objectStoreNames.contains('projects')) {
                        output.innerHTML += '<span class="error">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö projects store</span>\n';
                        return;
                    }

                    const transaction = database.transaction('projects', 'readonly');
                    const store = transaction.objectStore('projects');
                    const getAllRequest = store.getAll();

                    getAllRequest.onsuccess = async function() {
                        const projects = getAllRequest.result;
                        
                        output.innerHTML += `<span class="info">üì¶ ‡∏û‡∏ö ${projects.length} ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡πÉ‡∏ô IndexedDB</span>\n\n`;
                        
                        if (projects.length === 0) {
                            output.innerHTML += '<span class="warning">‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡πÉ‡∏´‡πâ sync</span>\n';
                            return;
                        }

                        let synced = 0;
                        for (const project of projects) {
                            try {
                                const docRef = doc(db, 'projects', project.id);
                                await setDoc(docRef, {
                                    ...project,
                                    userId: currentUser.uid,
                                    createdAt: serverTimestamp(),
                                    updatedAt: serverTimestamp()
                                });
                                
                                output.innerHTML += `<span class="success">‚úÖ Synced: ${project.title}</span>\n`;
                                synced++;
                            } catch (error) {
                                output.innerHTML += `<span class="error">‚ùå Failed: ${project.title} - ${error.message}</span>\n`;
                            }
                        }
                        
                        output.innerHTML += `\n<span class="success">üéâ Sync ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ${synced}/${projects.length} ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ</span>\n`;
                    };
                };
            } catch (error) {
                output.innerHTML += `<span class="error">‚ùå Error: ${error.message}</span>\n`;
            }
        };

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        window.createTestProject = async function() {
            const output = document.getElementById('create-output');
            output.innerHTML = '<span class="info">‚ûï ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö...</span>\n\n';

            try {
                const dbRequest = indexedDB.open('PeaceScriptDB', 1);
                
                dbRequest.onupgradeneeded = function(event) {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains('projects')) {
                        database.createObjectStore('projects', { keyPath: 'id' });
                    }
                };

                dbRequest.onsuccess = function(event) {
                    const database = event.target.result;
                    const transaction = database.transaction('projects', 'readwrite');
                    const store = transaction.objectStore('projects');
                    
                    const testProject = {
                        id: 'test-' + Date.now(),
                        title: 'Test Project ' + new Date().toLocaleTimeString('th-TH'),
                        projectType: 'Movie',
                        lastModified: Date.now(),
                        genre: 'Drama',
                        targetAudience: 'General',
                        characters: [],
                        structure: [],
                        generatedScenes: {}
                    };

                    const addRequest = store.add(testProject);
                    
                    addRequest.onsuccess = function() {
                        output.innerHTML += `<span class="success">‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>\n`;
                        output.innerHTML += `<span class="info">  ID: ${testProject.id}</span>\n`;
                        output.innerHTML += `<span class="info">  Title: ${testProject.title}</span>\n\n`;
                        output.innerHTML += `<span class="warning">üí° ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡∏≠‡∏á "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IndexedDB" ‡πÉ‡∏´‡∏°‡πà‡∏î‡∏π</span>\n`;
                    };

                    addRequest.onerror = function() {
                        output.innerHTML += `<span class="error">‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${addRequest.error}</span>\n`;
                    };
                };

                dbRequest.onerror = function() {
                    output.innerHTML += `<span class="error">‚ùå ‡πÄ‡∏õ‡∏¥‡∏î IndexedDB ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>\n`;
                };
            } catch (error) {
                output.innerHTML += `<span class="error">‚ùå Error: ${error.message}</span>\n`;
            }
        };
    </script>
</body>
</html>
