# üìä Admin Analytics Dashboard - Enhanced Features

## üÜï What's New

### 1. Enhanced User Details Modal

‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á

**Features:**

- ‚úÖ **Model Usage Tracking** - ‡∏î‡∏π‡∏ß‡πà‡∏≤ user ‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô
  - Text Generation: Gemini 2.0 Flash, Gemini 2.5 Flash
  - Image Generation: Pollinations, ComfyUI SDXL, ComfyUI FLUX, Gemini Imagen
  - Video Generation: Replicate SVD, Replicate AnimateDiff, Gemini Veo
- ‚úÖ **Generation Costs** - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡∏ö‡∏≤‡∏ó)
  - ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Text/Image/Video
  - ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°
- ‚úÖ **Offline Activity** - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå
  - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô sessions
  - ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠ session
  - Device info (browser, OS)
  - Location data (country, region, timezone)
- ‚úÖ **Activity Log** - ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ generate ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  - ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
  - ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
  - ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (credits + THB)
  - Prompt (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à/‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)

### 2. Project Cost Dashboard

‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà

**Cost Categories:**

1. **üîå API Services**
   - Gemini API (text, image, video)
   - Replicate API (SVD, AnimateDiff, LTX Video)
   - ComfyUI (Free - Local)
   - Pollinations (Free)

2. **üíæ Storage**
   - Firebase Storage (images, videos)
   - Cloud Storage

3. **‚öôÔ∏è Compute**
   - Cloud Run (Voice Cloning API - 2 vCPU, 8Gi RAM)
   - Cloud Functions (Node.js 20)

4. **üóÑÔ∏è Database**
   - Firestore (reads, writes, storage)

5. **üåê Bandwidth**
   - Firebase Hosting
   - CDN

6. **üì¶ Other Services**
   - Authentication
   - Domain & DNS

**Profitability Metrics:**

- Total Revenue (from subscriptions)
- Total Costs
- Net Profit
- Profit Margin (%)
- Active Users
- Cost per User

**Cost Trends:**

- Last 6 months chart
- Breakdown by API/Compute/Storage

## üìä Real API Pricing (as of Dec 2024)

### Gemini API

- **2.0 Flash**: FREE (with quota: 1,500 requests/day)
- **2.5 Flash Image**: ‡∏ø0.09 per image
- **Veo 3**:
  - 5s video: ‡∏ø3.50
  - 10s video: ‡∏ø17.50

### Replicate API

- **Stable Video Diffusion**: ‡∏ø0.63 per video
- **AnimateDiff**: ‡∏ø0.875 per video
- **LTX Video**: ‡∏ø5.25 per video

### Firebase

- **Hosting**: FREE (10 GB, 360 MB/day)
- **Firestore**: FREE (50K reads, 20K writes/day)
- **Cloud Functions**: FREE (2M invocations/month)
- **Authentication**: FREE (unlimited users)
- **Storage**: FREE (5 GB, 1 GB downloads/day)

### Google Cloud

- **Cloud Run**:
  - CPU: ‡∏ø0.002187 per vCPU-second
  - Memory: ‡∏ø0.000227 per GiB-second
  - Requests: ‡∏ø0.40 per 1M requests

## üîß Implementation

### Backend Services

#### 1. Model Usage Tracker (`modelUsageTracker.ts`)

```typescript
// Record a generation
await recordGeneration({
  userId: 'user-id',
  type: 'image',
  modelId: 'gemini-2.5-flash',
  modelName: 'Gemini 2.5 Flash Image',
  provider: 'gemini',
  costInCredits: 5,
  costInTHB: 0.09,
  success: true,
  duration: 15,
  metadata: {
    prompt: 'A beautiful sunset...',
    resolution: '1024x1024',
    projectId: 'project-123',
  },
});

// Get user model usage
const usage = await getUserModelUsage('user-id');
console.log(usage.totalGenerations); // 50
console.log(usage.totalCostTHB); // ‡∏ø125.50

// Get recent activity
const activity = await getRecentGenerations('user-id', 20);
```

#### 2. Project Cost Monitor (`projectCostMonitor.ts`)

```typescript
// Get comprehensive cost summary
const summary = await getProjectCostSummary();
console.log(summary.totalMonthlyCost); // ‡∏ø1,234.56
console.log(summary.userCosts.profit); // ‡∏ø5,678.90

// Get cost trends
const trends = await getCostTrends(6);
console.log(trends); // Last 6 months

// Export to CSV
const csv = exportCostDataToCSV(summary);
```

#### 3. Session Tracking

```typescript
// Record user session
await recordUserActivity({
  userId: 'user-id',
  sessionDuration: 45, // minutes
  deviceInfo: {
    browser: 'Chrome',
    os: 'Windows 11',
    device: 'Desktop',
  },
  locationData: {
    country: 'Thailand',
    region: 'Bangkok',
    timezone: 'Asia/Bangkok',
  },
});

// Get offline activity
const offline = await getUserOfflineActivity('user-id');
console.log(offline.sessionCount); // 25
console.log(offline.avgSessionDuration); // 38.5 min
```

### Frontend Components

#### 1. EnhancedUserDetailsModal

```tsx
import { EnhancedUserDetailsModal } from './components/admin/EnhancedUserDetailsModal';

<EnhancedUserDetailsModal userId="user-id" onClose={() => setSelectedUserId(null)} />;
```

**Features:**

- 3 tabs: Overview, Model Usage, Activity Log
- Real-time cost calculations
- Offline activity tracking
- Responsive design

#### 2. ProjectCostDashboard

```tsx
import { ProjectCostDashboard } from './components/admin/ProjectCostDashboard';

<ProjectCostDashboard />;
```

**Features:**

- Cost breakdown by category
- Profitability metrics
- Cost trends chart (6 months)
- CSV export

## üìà Firestore Structure

### Collections

#### `generations` (new)

```typescript
{
  id: string;
  userId: string;
  timestamp: Timestamp;
  type: 'text' | 'image' | 'video';
  modelId: string;
  modelName: string;
  provider: string;
  costInCredits: number;
  costInTHB: number;
  success: boolean;
  duration?: number;
  metadata?: {
    prompt?: string;
    resolution?: string;
    duration?: string;
    projectId?: string;
    sceneId?: string;
  };
}
```

#### `userModelUsage` (new)

```typescript
{
  id: '{userId}_{modelId}'; // composite key
  userId: string;
  modelId: string;
  modelName: string;
  provider: string;
  type: 'text' | 'image' | 'video';
  count: number;
  totalCost: number; // THB
  lastUsed: Timestamp;
}
```

#### `userActivity` (new)

```typescript
{
  id: '{userId}';
  userId: string;
  lastOnline: Timestamp;
  sessionCount: number;
  avgSessionDuration: number; // minutes
  totalTimeSpent: number; // minutes
  deviceInfo: {
    browser: string;
    os: string;
    device: string;
  };
  locationData?: {
    country: string;
    region: string;
    timezone: string;
  };
}
```

## üéØ Integration Guide

### Step 1: Add tracking to existing generation functions

**Example: Image Generation**

```typescript
import { trackGeneration } from './services/modelUsageTracker';

async function generateImage(prompt: string) {
  return await trackGeneration(
    auth.currentUser!.uid,
    'image',
    'gemini-2.5-flash',
    'Gemini 2.5 Flash Image',
    'gemini',
    async () => {
      // Your existing image generation code
      const result = await geminiGenerateImage(prompt);
      return result;
    },
    {
      prompt,
      resolution: '1024x1024',
      projectId: currentProject.id,
    }
  );
}
```

### Step 2: Add session tracking to app initialization

```typescript
import { recordUserActivity } from './services/modelUsageTracker';

useEffect(() => {
  const sessionStart = Date.now();

  // Detect device info
  const deviceInfo = {
    browser: navigator.userAgent.includes('Chrome') ? 'Chrome' : 'Other',
    os: navigator.platform,
    device: /Mobile/.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
  };

  // Record session on unmount
  return () => {
    const sessionDuration = (Date.now() - sessionStart) / 1000 / 60; // minutes

    recordUserActivity({
      userId: auth.currentUser!.uid,
      sessionDuration,
      deviceInfo,
      locationData: {
        country: 'Thailand', // Get from IP geolocation API
        region: 'Bangkok',
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      },
    });
  };
}, []);
```

### Step 3: Update Admin Dashboard

Already done! The new components are integrated into the Admin Dashboard:

- **Tab 1**: Analytics & Users (existing)
- **Tab 2**: üí∞ Project Costs (new)
- **Tab 3**: Admin Management (existing)
- **Tab 4**: Alerts (existing)

Click on any user in the table to see enhanced details.

## üìä Benefits

### For Admins

1. **Transparency** - ‡πÄ‡∏´‡πá‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
2. **Profitability** - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠ user
3. **Optimization** - ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏´‡∏ô
4. **User Behavior** - ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á users

### For Business

1. **Cost Control** - ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
2. **Pricing Strategy** - ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
3. **Resource Planning** - ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
4. **Profit Maximization** - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°

## üîê Security

- ‚úÖ Admin-only access (require admin authentication)
- ‚úÖ User privacy protected (no sensitive data exposed)
- ‚úÖ Cost data calculated on-demand (not stored)
- ‚úÖ Activity tracking anonymous (no personal identifiers)

## üìù TODO

- [ ] Add IP geolocation API for accurate location data
- [ ] Implement real-time cost alerts
- [ ] Add cost budget limits per tier
- [ ] Export detailed user reports (PDF)
- [ ] Add cost forecasting (next 3 months)
- [ ] Integrate with payment gateway for auto-billing

## üéâ Summary

‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:

- **User Details**: ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ user ‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏≠‡∏∞‡πÑ‡∏£, ‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà, ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà
- **Project Costs**: ‡∏£‡∏π‡πâ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà, ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏´‡∏ô
- **Activity Tracking**: ‡∏£‡∏π‡πâ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô, session duration, device info

All data is real-time and based on actual API pricing! üéØ
